<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auto Refresh Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

  <!-- Tableau Extensions API -->
  <script src="https://tableau.github.io/extensions-api/lib/tableau.extensions.1.latest.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      margin: 20px;
    }
    h3 {
      margin-bottom: 20px;
    }
    #datasources {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .btn {
      min-width: 100px;
    }
    .form-group label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h3>Configure Auto Refresh</h3>

  <!-- Refresh Interval -->
  <div class="form-group">
    <label for="interval">Refresh Interval (seconds)</label>
    <input type="number" id="interval" class="form-control" min="5" value="60">
  </div>

  <!-- Datasource selection -->
  <div class="form-group">
    <label>Select Data Sources</label>
    <div id="datasources"></div>
  </div>

  <!-- Buttons -->
  <div class="text-right">
    <button id="closeButton" class="btn btn-primary">Save</button>
  </div>

  <script>
    'use strict';
    (function () {
      const datasourcesSettingsKey = 'selectedDatasources';
      const intervalkey = 'intervalkey';
      const configured = 'configured';
      let selectedDatasources = [];

      $(document).ready(function () {
        tableau.extensions.initializeDialogAsync().then(function (openPayload) {
          $('#interval').val(openPayload);
          $('#closeButton').click(closeDialog);

          let dashboard = tableau.extensions.dashboardContent.dashboard;
          let visibleDatasources = [];

          if (tableau.extensions.settings.get(configured) == 1) {
            $('#interval').val(tableau.extensions.settings.get(intervalkey));
          } else {
            $('#interval').val(60);
          }

          selectedDatasources = parseSettingsForActiveDataSources();
          dashboard.worksheets.forEach(function (worksheet) {
            worksheet.getDataSourcesAsync().then(function (datasources) {
              datasources.forEach(function (datasource) {
                let isActive = (selectedDatasources.indexOf(datasource.id) >= 0);

                if (visibleDatasources.indexOf(datasource.id) < 0) {
                  addDataSourceItemToUI(datasource, isActive);
                  visibleDatasources.push(datasource.id);
                }
              });
            });
          });
        });
      });

      function parseSettingsForActiveDataSources() {
        let activeDatasourceIdList = [];
        let settings = tableau.extensions.settings.getAll();
        if (settings.selectedDatasources) {
          activeDatasourceIdList = JSON.parse(settings.selectedDatasources);
        }
        return activeDatasourceIdList;
      }

      function updateDatasourceList(id) {
        let idIndex = selectedDatasources.indexOf(id);
        if (idIndex < 0) {
          selectedDatasources.push(id);
        } else {
          selectedDatasources.splice(idIndex, 1);
        }
      }

      function addDataSourceItemToUI(datasource, isActive) {
        let containerDiv = $('<div class="checkbox" />');
        $('<label />').append(
          $('<input />', {
            type: 'checkbox',
            id: datasource.id,
            checked: isActive,
            click: function () { updateDatasourceList(datasource.id); }
          })
        ).append(' ' + datasource.name).appendTo(containerDiv);

        $('#datasources').append(containerDiv);
      }

      function closeDialog() {
        tableau.extensions.settings.set(datasourcesSettingsKey, JSON.stringify(selectedDatasources));
        tableau.extensions.settings.set(intervalkey, $('#interval').val());
        tableau.extensions.settings.set(configured, 1);

        tableau.extensions.settings.saveAsync().then(() => {
          tableau.extensions.ui.closeDialog($('#interval').val());
        });
      }
    })();
  </script>
</body>
</html>
